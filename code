#pragma config FOSC = HS, WDTE = OFF, PWRTE = ON, BOREN = OFF, LVP = OFF, CPD = OFF, WRT = OFF, CP = OFF
#define _XTAL_FREQ 4000000
#include <xc.h>

#define RS RC0
#define EN RC1


void lcd_cmd(unsigned char cmd)
{
    RS=0;
    PORTD = (PORTD & 0x0F) | (cmd & 0xF0);
    EN=1; __delay_ms(2); EN=0;

    PORTD = (PORTD & 0x0F) | ((cmd<<4) & 0xF0);
    EN=1; __delay_ms(2); EN=0;
}

void lcd_data(unsigned char data)
{
    RS=1;
    PORTD = (PORTD & 0x0F) | (data & 0xF0);
    EN=1; __delay_ms(2); EN=0;

    PORTD = (PORTD & 0x0F) | ((data<<4) & 0xF0);
    EN=1; __delay_ms(2); EN=0;
}

void lcd_init()
{
    __delay_ms(20);
    lcd_cmd(0x02);
    lcd_cmd(0x28);
    lcd_cmd(0x0C);
    lcd_cmd(0x06);
    lcd_cmd(0x01);
}
char keypad()
{
    char keymap[4][4]={{'7','8','9','/'},
                       {'4','5','6','*'},
                       {'1','2','3','-'},
                       {'C','0','=','+'}};

    for(unsigned char row=0; row<4; row++)
    {
        PORTB = (unsigned char)(~(1<<row));
        for(unsigned char col=0; col<4; col++)
        {
            if(!(PORTB & (1<<(col+4))))
            {
                __delay_ms(200);
                return keymap[row][col];
            }
        }
    }
    return 0;
}

int num1=0, num2=0;
unsigned char second = 0;
char op=0;

void main()
{
    TRISD=0x00;
    TRISC0=0; TRISC1=0;
    TRISB=0xF0;
    OPTION_REG &= 0x7F;

    lcd_init();

    while(1)
    {
        char key = keypad();
        if(key)
        {
            lcd_data(key);

            if(key>='0' && key<='9')
            {
                if(!second)
                    num1 = num1*10 + (key-'0');
                else
                    num2 = num2*10 + (key-'0');
            }

            else if(key=='+'||key=='-'||key=='*'||key=='/')
            {
                op=key;
                second=1;
            }

            else if(key=='=')
            {
                int res=0;

                if(op=='+') res=num1+num2;
                if(op=='-') res=num1-num2;
                if(op=='*') res=num1*num2;
                if(op=='/') res=num1/num2;

                lcd_cmd(0xC0);
                if(res>=10) lcd_data(res/10+'0');
                lcd_data(res%10+'0');

                num1=0; num2=0; second=0;
            }

            else if(key=='C')
            {
                lcd_cmd(0x01);
                num1=0; num2=0; second=0;
            }
        }
    }
}
